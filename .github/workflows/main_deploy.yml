# Pipeline CI/CD pour d√©ployer automatiquement le code Salesforce
# Utilise sfdx-git-delta pour d√©ployer uniquement les fichiers modifi√©s
# Se d√©clenche sur push ou pull request vers la branche main

name: Deploy and Validate Metadata

# D√©clencheurs : le pipeline s'ex√©cute sur push ou pull request vers main
on:
  pull_request:
    branches:
      - main

  push:
    branches:
      - main

# D√©finit les diff√©rents jobs (t√¢ches) qui composent ce workflow
jobs:
  # Job pour valider et d√©ployer les m√©tadonn√©es
  sfdxvalidate:
    name: "Run SFDX Validate and Deploy"
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x]

    steps:
      # √âtape 1 : R√©cup√®re le code depuis GitHub
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # N√©cessaire pour sfdx-git-delta qui compare les commits

      # √âtape 2 : Configure Node.js
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      # √âtape 3 : Installe Salesforce CLI et le plugin sfdx-git-delta
      # sfdx-git-delta permet de d√©ployer uniquement les fichiers modifi√©s (delta)
      - name: Install SFDX CLI and sfdx-git-delta plugin
        run: |
          npm install -g @salesforce/cli@latest
          echo "y" | npm install sfdx-git-delta@3.3.0 -g

      # √âtape 4 : Authentification √† Salesforce
      # Utilise les secrets GitHub pour se connecter √† Salesforce
      - name: Authentification Salesforce
        env:
          SF_USERNAME: ${{ secrets.SF_USERNAME }}
          SF_PASSWORD: ${{ secrets.SF_PASSWORD }}
          SF_SECURITY_TOKEN: ${{ secrets.SF_SECURITY_TOKEN }}
          SF_LOGIN_URL: ${{ secrets.SF_LOGIN_URL }}
        run: |
          # Utilise l'URL de connexion SFDX pour s'authentifier
          echo "$SF_LOGIN_URL" | sf org login sfdx-url --sfdx-url-file /dev/stdin \
            --alias deploy-org \
            --set-default-username "$SF_USERNAME"

      # √âtape 5 : G√©n√®re le delta des m√©tadonn√©es modifi√©es
      # Compare les fichiers entre la branche actuelle et main
      # G√©n√®re un package.xml avec uniquement les fichiers modifi√©s
      - name: Generate metadata delta
        id: delta
        run: |
          # Cr√©e un r√©pertoire temporaire pour le package.xml
          mkdir -p .temp/package
          
          # Pour les pull requests, compare avec la branche de base
          # Pour les pushes sur main, compare avec le commit pr√©c√©dent
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            # Pour un push, compare avec le commit pr√©c√©dent
            BASE_SHA=$(git rev-parse HEAD~1)
            HEAD_SHA="${{ github.sha }}"
          fi
          
          echo "üîç Comparaison: $BASE_SHA -> $HEAD_SHA"
          
          # G√©n√®re le package.xml avec sfdx-git-delta
          # La commande sgd:source:delta g√©n√®re le delta des m√©tadonn√©es
          sf sgd:source:delta \
            --to "$HEAD_SHA" \
            --from "$BASE_SHA" \
            --output .temp/package \
            --generate-delta || {
              echo "‚ö†Ô∏è Erreur lors de la g√©n√©ration du delta, tentative alternative..."
              # Alternative: d√©ployer tout le projet si le delta √©choue
              echo "has_changes=true" >> $GITHUB_OUTPUT
              exit 0
            }
          
          # V√©rifie si des fichiers ont √©t√© modifi√©s
          if [ -f .temp/package/package.xml ] && [ -s .temp/package/package.xml ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "‚úÖ M√©tadonn√©es modifi√©es d√©tect√©es"
            echo "üì¶ Contenu du package.xml:"
            cat .temp/package/package.xml
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Aucune m√©tadonn√©e modifi√©e"
          fi

      # √âtape 6 : Valide les m√©tadonn√©es (sans d√©ployer)
      # S'ex√©cute toujours pour v√©rifier la syntaxe
      - name: Validate metadata
        if: steps.delta.outputs.has_changes == 'true'
        run: |
          # Valide les m√©tadonn√©es sans les d√©ployer
          # Utilise le r√©pertoire source g√©n√©r√© par sfdx-git-delta
          if [ -f .temp/package/package.xml ]; then
            echo "‚úÖ Validation des m√©tadonn√©es..."
            sf project deploy validate \
              --source-dir .temp/package \
              --target-org deploy-org \
              --wait 10 || {
                echo "‚ö†Ô∏è Erreur de validation (peut √™tre normal si pas de m√©tadonn√©es)"
                exit 0
              }
          else
            echo "‚ö†Ô∏è Aucun package.xml trouv√©, validation ignor√©e"
          fi

      # √âtape 7 : Ex√©cute les tests (pour les pull requests)
      # V√©rifie que les tests passent avant de merger
      - name: Run Apex Tests
        if: github.event_name == 'pull_request' && steps.delta.outputs.has_changes == 'true'
        run: |
          # Ex√©cute tous les tests locaux
          sf apex run test \
            --test-level RunLocalTests \
            --code-coverage \
            --result-format human \
            --wait 10 \
            --target-org deploy-org || true

      # √âtape 8 : D√©ploie les m√©tadonn√©es sur main
      # Seulement si c'est un push sur main (pas une pull request)
      - name: D√©ployer les m√©tadonn√©es sur la branch main
        if: github.ref == 'refs/heads/main' && github.event_name == 'push' && steps.delta.outputs.has_changes == 'true'
        run: |
          # D√©ploie les m√©tadonn√©es modifi√©es depuis le package g√©n√©r√©
          if [ -f .temp/package/package.xml ]; then
            echo "üöÄ D√©ploiement des m√©tadonn√©es modifi√©es..."
            sf project deploy start \
              --source-dir .temp/package \
              --target-org deploy-org \
              --test-level RunLocalTests \
              --wait 10
            
            # V√©rifie le rapport de d√©ploiement
            echo "üìä Rapport de d√©ploiement:"
            sf project deploy report \
              --target-org deploy-org
          else
            echo "‚ö†Ô∏è Aucun package.xml trouv√©, d√©ploiement de tout le projet..."
            # Alternative: d√©ployer tout le projet si le delta n'a pas fonctionn√©
            sf project deploy start \
              --source-dir force-app \
              --target-org deploy-org \
              --test-level RunLocalTests \
              --wait 10
          fi

      # √âtape 9 : G√©n√®re un rapport de couverture de code (s'ex√©cute toujours)
      - name: Generate Test Coverage Report
        if: always() && steps.delta.outputs.has_changes == 'true'
        run: |
          # R√©cup√®re le rapport de test, m√™me si les tests ont √©chou√©
          sf apex get test \
            --code-coverage \
            --result-format human \
            --target-org deploy-org || true
